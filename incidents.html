<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IRR — DAG · Similar Incidents</title>

  <!-- Bootstrap 5 + DataTables (Bootstrap 5 theme) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.css" rel="stylesheet">

  <!-- App icon + shared styles -->
  <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='image/KeyBank_icon.svg') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/style.css') }}">
</head>

<body>
  <!-- Top bar (consistent across pages) -->
  <nav class="navbar navbar-expand-lg border-bottom app-navbar">
    <div class="container-fluid px-3">
      <a class="navbar-brand d-flex align-items-center gap-2" href="{{ url_for('home') }}">
        <span class="brand-dot"></span>
        <span class="fw-semibold">IRR</span>
        <span class="opacity-75">—</span>
        <span class="fw-bold fst-italic">DAG</span>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto align-items-center gap-3">
          <li class="nav-item">
            <img src="{{ url_for('static', filename='image/logo.png') }}" class="image" alt="Logo" height="24">
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Page header + toolbar (search) -->
  <header class="container-xxl py-4">
    <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3">
      <div>
        <h1 class="h4 mb-1">Similar Incidents</h1>
        <p class="text-secondary mb-0">
          For incident <span class="fw-semibold" style="color:#b30000">{{ incident_number }}</span> —
          <span class="fw-semibold">Short Description:</span>
          <span class="fw-normal" style="color:#b30000">{{ incident_short_description }}</span>
        </p>
      </div>

      <div class="toolbar card border-0 shadow-sm p-2">
        <div class="row g-2 align-items-center">
          <div class="col-12 col-md">
            <div class="input-group">
              <span class="input-group-text bg-transparent border-0 ps-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001l3.85 3.85a1 1 0 0 0 1.415-1.415l-3.85-3.85zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/>
                </svg>
              </span>
              <input id="globalSearch" type="search" class="form-control border-0" placeholder="Search by number, title, percentage…" />
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Results table -->
  <main class="container-xxl pb-5">
    <div class="card shadow-sm border-0">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table id="relatedTable" class="table table-hover align-middle mb-0">
            <thead class="table-light sticky-top">
              <tr>
                <th style="width:160px;">Incident Number</th>
                <th>Short Description</th>
                <th style="width:200px;">Percentage</th>
                <th style="width:160px;">Action</th>
                <th style="width:110px;">Like</th>
                <th style="width:110px;">Dislike</th>
              </tr>
            </thead>
            <tbody>
              {% if related_incidents %}
                {% for incident in related_incidents %}
                  {% set incident['Percentage'] = incident['Percentage']|int %}
                  {% if incident['Percentage'] > 75 %}
                    {% set bar_class = 'bg-success' %}
                  {% elif incident['Percentage'] >= 30 and incident['Percentage'] <= 75 %}
                    {% set bar_class = 'bg-warning' %}
                  {% else %}
                    {% set bar_class = 'bg-danger' %}
                  {% endif %}

                  <tr>
                    <td>
                      <span class="fw-semibold link-like">{{ incident['Number'] }}</span>
                    </td>
                    <td class="description-cell">
                      {{ incident['title'] }}
                    </td>
                    <td>
                      <div class="d-flex align-items-center justify-content-between">
                        <small class="text-muted">{{ incident['incidents_count'] }} / {{ incident['Total_Count'] }}</small>
                        <small class="fw-semibold">{{ incident['Percentage'] }}%</small>
                      </div class ="progress-bar {{ bar_class }}" aria-valuemin="0" aria-valuemax="100" style="height:10px;">
                        <div class="progress-bar {{ bar_class }}" style="width: {{ incident['Percentage'] }}%"></div>
                      </div>
                      
                    </td>
                    <td>
                      <form action="{{ url_for('view_resolution') }}" method="post" class="m-0">
                        <input type="hidden" name="incident_number" value="{{ incident['Number'] }}">
                        <input type="hidden" name="original_incident" value="{{ incident_number }}">
                        <input type="hidden" name="original_ShortDescription" value="{{ incident_short_description }}">
                        <button class="btn btn-link p-0 align-baseline fw-semibold text-decoration-none link-like" type="submit">
                          view resolutions
                        </button>
                      </form>
                    </td>
                    <td>
                      <button type="button" class="btn btn-sm btn-success">Like {{ incident['like'] }}</button>
                    </td>
                    <td>
                      <button type="button" class="btn btn-sm btn-danger">Dislike {{ incident['dislike'] }}</button>
                    </td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td></td>
                  <td><span style="color:#b30000; font-weight:600;">No History Found</span></td>
                  <td></td><td></td><td></td><td></td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    {% if not related_incidents %}
      <div class="mt-3">
        <form action="{{ url_for('state') }}" method="post" class="m-0">
          <input type="hidden" name="original_incident" value="{{ incident_number }}">
          <input type="hidden" name="original_resolution" value="NA">
          <button class="btn btn-link p-0 align-baseline fw-semibold text-decoration-none link-like" type="submit">
            Click here to close the incidents in ServiceNow
          </button>
        </form>
      </div>
    {% endif %}
  </main>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/2.0.8/js/dataTables.js"></script>
  <script src="https://cdn.datatables.net/2.0.8/js/dataTables.bootstrap5.js"></script>

  <script>
    // DataTable
    const dt = new DataTable('#relatedTable', {
      paging: true,
      pageLength: 10,
      order: [[2, 'desc']],   // sort by Percentage column initially
      layout: { topStart: null } // hide default controls, we use our toolbar
    });

    // Toolbar search
    document.getElementById('globalSearch').addEventListener('input', (e) => {
      dt.search(e.target.value).draw();
    });
  </script>
</body>
</html>

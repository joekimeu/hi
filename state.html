{% extends "layout.html" %}
{% block content %}
<br/>
<div class="container">
  <div class="row">
    <div class="col-10 col-xxl-10 col-xl-10 col-lg-10 col-md-10 col-sm-10">
      {% if original_resolution =="NA" %}
      <form action="{{url_for('show_related_incidents')}}" method="post">
        <input type="hidden" name="incident_number" value="{{original_incident}}">
        <button class="link-btn" type="submit">
          <i class="fa fa-arrow-left fa-2x" style="color:rgb(204, 0, 0)" aria-hidden="true"></i>
          <span style="color: rgb(204, 0, 0); font-weight: bold; font-size: 18px;"> Back</span>
        </button>
      </form>
      {% else %}
      <form action="{{url_for('view_resolution')}}" method="post">
        <input type="hidden" name="incident_number" value="{{incident_number}}">
        <input type="hidden" name="original_incident" value="{{original_incident}}">
        <input type="hidden" name="original_ShortDescription" value="{{original_ShortDescription}}">
        <button class="link-btn" type="submit">
          <i class="fa fa-arrow-left fa-2x" style="color:rgb(204, 0, 0)" aria-hidden="true"></i>
          <span style="color: rgb(204, 0, 0); font-weight: bold; font-size: 18px;"> Back</span>
        </button>
      </form>
      {% endif %}
    </div>

    <div class="col-2 col-xxl-2 col-xl-2 col-lg-2 col-md-2 col-sm-2">
      <a href="{{url_for('home')}}">
        <i class="fa fa-home fa-2x" style="color:rgb(204, 0, 0)" aria-hidden="true"></i>
        <span style="color: rgb(204, 0, 0); font-weight: bold; font-size: 18px;"> Home</span>
      </a>
    </div>
  </div>

  <div class="row">
    <div class="col-12">

      <!-- originals (hidden) -->
      <textarea style="display:none;" id="original_resolution" class="form-control" rows="3">{{original_resolution}}</textarea>
      <textarea style="display:none;" id="original_causecode" class="form-control" rows="3">{{original_causecode}}</textarea>

      <!-- Unified form -->
      <label for="state"><b>State<span style="color:red">*</span></b></label>
      <select id="state" class="form-control">
        <option value="">---Select State---</option>
      </select>

      <label for="sub_state"><b>Sub State <span style="color:red">*</span></b></label>
      <select id="sub_state" class="form-control">
        <option value="">---Select Sub State---</option>
      </select>

      <!-- conditional inputs -->
      <div id="Pending_Problem" class="mt-2" style="display:none;">
        <label for="PendingProblem"><b>Problem No. <span style="color:red">*</span></b></label>
        <textarea id="PendingProblem" class="form-control" rows="1"></textarea>
      </div>

      <div id="Pending_Change" class="mt-2" style="display:none;">
        <label for="PendingChange"><b>Change No. <span style="color:red">*</span></b></label>
        <textarea id="PendingChange" class="form-control" rows="1"></textarea>
      </div>

      <div id="Duplicate" class="mt-2" style="display:none;">
        <label for="duplicate"><b>Parent Incident <span style="color:red">*</span></b></label>
        <textarea id="duplicate" class="form-control" rows="1"></textarea>
      </div>

      <label for="cause_code"><b>Cause Code <span style="color:red">*</span></b> <span id="causecode_hint" style="display:none;"></span></label>
      <select id="cause_code" class="form-control">
        <option value="">---Select Cause Code---</option>
      </select>

      <label for="category"><b>Category <span style="color:red">*</span></b> <span id="category_hint" style="display:none;"></span></label>
      <select id="category" class="form-control">
        <option value="">---Select Category---</option>
      </select>

      <label for="sub_category"><b>Sub Category <span style="color:red">*</span></b> <span id="subcategory_hint" style="display:none;"></span></label>
      <select id="sub_category" class="form-control">
        <option value="">---Select Sub Category---</option>
      </select>

      <label for="work_notes"><b>Work Notes</b></label>
      <textarea id="work_notes" class="form-control" rows="3"></textarea>

      <label for="details">
        <b>Detailed RCA</b> <span style="color:red">*</span>
        <span style="display:none;" class="score-indicator">Score: <span id="details-label-score">0</span></span>
      </label>
      <textarea id="details" class="form-control" rows="3"></textarea>
      <div id="detailsFeedback" class="feedback"></div>

      <label for="action_taken">
        <b>Action Taken</b> <span style="color:red">*</span>
        <span style="display:none;" class="score-indicator">Score: <span id="action-label-score">0</span></span>
      </label>
      <textarea id="action_taken" class="form-control" rows="3"></textarea>
      <div id="actionFeedback" class="feedback"></div>

      <label for="resolution_type"><b>Resolution Type <span style="color:red">*</span></b></label>
      <select id="resolution_type" class="form-control">
        <option value="">---Select Resolution Type---</option>
      </select>

      <!-- changed: explicit type="button" so it never submits anything -->
      <button id="submitBtn" type="button" class="btn btn-primary mt-3">Submit</button>
      <div id="errorMsg" class="text-danger mt-2" style="display:none;"></div>

      <button id="resetBtn" type="button" class="btn btn-danger mt-3">Reset</button>

      <!-- ONE modal -->
      <div class="modal fade" id="myModal">
        <div class="modal-dialog">
          <div class="modal-content">

            <div class="modal-header">
              <h4 class="modal-title">Selected Data</h4>
              <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>

            <form id="textForm">
              <div class="modal-body">

                <label>State</label>
                <input type="text" id="modalState" class="form-control" readonly>

                <label>Sub State</label>
                <input type="text" id="modalSubState" class="form-control" readonly>

                <div id="a1" style="display:none;">
                  <label>Problem Number</label>
                  <input type="text" id="modalProblem" class="form-control" readonly>
                </div>

                <div id="a2" style="display:none;">
                  <label>Change Number</label>
                  <input type="text" id="modalChange" class="form-control" readonly>
                </div>

                <div id="a3" style="display:none;">
                  <label>Duplicate Value</label>
                  <input type="text" id="modalDuplicate" class="form-control" readonly>
                </div>

                <label>Cause Code</label>
                <input type="text" id="modalCause" class="form-control" readonly>

                <label>Work Notes</label>
                <input type="text" id="modalWork" class="form-control" readonly>

                <label>Closure Note</label>
                <textarea id="modalText" class="form-control" rows="5" readonly></textarea>

                <input id="original_inc" type="text" value="{{original_incident}}" hidden>
              </div>

              <div class="modal-footer">
                <!-- saveBtn will be disabled/greyed-out on first click -->
                <button id="saveBtn" class="btn btn-success" type="submit">Submit</button>
                <button type="button" class="btn btn-default" data-bs-dismiss="modal">Close</button>
              </div>
            </form>

          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script src="{{ url_for('static',filename='node_modules2/jquery/dist/jquery.min.js') }}"></script>
<script src="{{ url_for('static',filename='node_modules2/bootstrap/dist/js/bootstrap.bundle.min.js') }}"></script>
<script src="{{ url_for('static',filename='node_modules2/datatables.net/js/dataTables.min.js') }}"></script>
<script src="{{ url_for('static',filename='node_modules2/datatables.net-bs5/js/dataTables.bootstrap5.min.js') }}"></script>

<script>
  // ---------- Centralized dropdown options (edit once) ----------
  const DROPDOWN_OPTIONS = {
    states: [
      { value: "resolved", label: "Resolved" },
      { value: "pending",  label: "Pending"  }
    ],
    subStates: [
      "Pending User Info",
      "Solved (Work Around)",
      "Pending Vendor",
      "Solved (Permanently)",
      "Access and Authentication",
      "Pending_Problem",
      "Pending_Change",
      "User Error/Knowledge",
      "Not Reproducible",
      "Unknown",
      "Closed/Resolved by Requested for",
      "Email Spam",
      "Duplicate",
      "No Action Taken"
    ],
    resolutionTypes: {
      resolved: [
        "Configuration Change",
        "Fix Deployed",
        "Network glitch",
        "No Action Required",
        "Performance Optimization",
        "Vendor issue",
        "Workaround Implemented"
      ],
      pending: [
        "Fix Deployed",
        "Workaround Implemented",
        "Configuration Change",
        "Performance Optimization",
        "No Action Required"
      ]
    }
  };

  function fillSelect(selectId, placeholderText, options) {
    const sel = document.getElementById(selectId);
    if (!sel) return;
    sel.innerHTML = `<option value="">${placeholderText}</option>`;
    options.forEach(opt => {
      const o = document.createElement("option");
      if (typeof opt === "string") {
        o.value = opt;
        o.textContent = opt;
      } else {
        o.value = opt.value;
        o.textContent = opt.label;
      }
      sel.appendChild(o);
    });
  }

  function setResolutionTypeOptions(stateVal) {
    const options = (DROPDOWN_OPTIONS.resolutionTypes[stateVal] || []);
    fillSelect("resolution_type", "---Select Resolution Type---", options);
  }

  function initDropdowns() {
    fillSelect("state", "---Select State---", DROPDOWN_OPTIONS.states);
    fillSelect("sub_state", "---Select Sub State---", DROPDOWN_OPTIONS.subStates);
    // default
    document.getElementById("state").value = "resolved";
    setResolutionTypeOptions("resolved");
  }

  // ---------- Keep your resolution parsing logic ----------
  let detailsScore = 0;
  let actionScore = 0;
  let selectedCategory;
  let selectedSubCategory;
  let selectedCause = (document.getElementById('original_causecode').value || "").trim();
  let jsonData = {};

  function resolution_split() {
    const closeNotes = document.getElementById('original_resolution').value || "";
    const marked = closeNotes.replace(/\bCategory : /gi,"|Category : ")
                             .replace(/\bSub_Category : /gi,"|Sub_Category : ")
                             .replace(/\bRCA : /gi,"|RCA : ")
                             .replace(/\bAction Taken : /gi,"|Action Taken : ")
                             .replace(/\bResolution Type:/gi,"|Resolution Type:");
    const parts = marked.split("|").map(p=>p.trim()).filter(Boolean);
    const result = {};
    parts.forEach(p=>{
      const idx = p.indexOf(":");
      if(idx !== -1) {
        const key = p.slice(0,idx).trim().toLowerCase();
        const val = p.slice(idx + 1).trim();
        result[key] = val;
      }
    });

    selectedCategory = result["category"];
    selectedSubCategory = result["sub_category"];

    // default sub_state + fill fields if present
    document.getElementById('sub_state').value = "Solved (Permanently)";
    document.getElementById('details').value = result["rca"] || "";
    document.getElementById('action_taken').value = result["action taken"] || "";
    document.getElementById('resolution_type').value = result["resolution type"] || "";

    const causecode_hint = document.getElementById('original_causecode').value || "";
    document.getElementById('causecode_hint').innerHTML = causecode_hint;
    document.getElementById('category_hint').innerHTML = selectedCategory || "";
    document.getElementById('subcategory_hint').innerHTML = selectedSubCategory || "";
  }

  // ---------- Score logic ----------
  function handleInput(event, field) {
    calculateScore(event.target.value, field);
  }

  function calculateScore(text, field) {
    fetch('/calculate-score', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({text:text})
    })
    .then(r => r.json())
    .then(data => updateFieldScore(field, data.score))
    .catch(err => {
      console.error('Error calculating score:', err);
      const feedbackElement = field === 'details' ? detailsFeedback : actionFeedback;
      feedbackElement.textContent = "Error calculating score. Please try again.";
      feedbackElement.style.backgroundColor = "#ffebee";
    });
  }

  function updateFieldScore(field, score) {
    const scoreElement = field === 'details' ? detailsScoreElement : actionScoreElement;
    const feedbackElement = field === 'details' ? detailsFeedback : actionFeedback;
    scoreElement.textContent = score;
    if (field === 'details') detailsScore = score;
    else actionScore = score;
    updateFeedback(score, feedbackElement);
  }

  function updateFeedback(score, element) {
    if (score < 40) {
      element.textContent = 'Poor details. Please add more details & keywords.';
      element.style.backgroundColor = "#ffebee";
    } else if (score < 70) {
      element.textContent = 'Almost there! Plese add more details & keywords.';
      element.style.backgroundColor = "#fff3e0";
    } else {
      element.textContent = 'Details looks good.';
      element.style.backgroundColor = "#e8f5e9";
    }
  }

  // ---------- Dependent dropdowns from data.json ----------
  function populateCauseCode() {
    let causeDropdown = $("#cause_code");
    causeDropdown.html('<option value="">---Select Cause Code---</option>');
    $.each(jsonData, function(cause_code){
      causeDropdown.append(`<option value="${cause_code}">${cause_code}</option>`);
    });
  }

  function populateCategory(cause_code) {
    $("#category").html('<option value="">Select Category</option>');
    $("#sub_category").html('<option value="">Select Sub Category</option>');
    if (jsonData[cause_code]) {
      $.each(jsonData[cause_code], function(category){
        $("#category").append(`<option value="${category}">${category}</option>`);
      });
    }
  }

  function populateSubCategory(cause_code, category) {
    $("#sub_category").html('<option value="">Select Sub Category</option>');
    if (jsonData[cause_code] && jsonData[cause_code][category]) {
      $.each(jsonData[cause_code][category], function(i, sub){
        $("#sub_category").append(`<option value="${sub}">${sub}</option>`);
      });
    }
  }

  function autoSelectValues() {
    if (jsonData[selectedCause]) {
      $("#cause_code").val(selectedCause);
      populateCategory(selectedCause);

      if (selectedCategory && jsonData[selectedCause][selectedCategory]) {
        $("#category").val(selectedCategory);
        populateSubCategory(selectedCause, selectedCategory);
        if (selectedSubCategory) $("#sub_category").val(selectedSubCategory);
      }
    }
  }

  // ---------- UI show/hide ----------
  function updateConditionalBlocks() {
    const sub = $("#sub_state").val();
    $("#Pending_Problem").toggle(sub === "Pending_Problem");
    $("#Pending_Change").toggle(sub === "Pending_Change");
    $("#Duplicate").toggle(sub === "Duplicate");
  }

  // ---------- Page init ----------
  initDropdowns();
  resolution_split();

  const detailsTextArea = document.getElementById('details');
  const actionTakenTextArea = document.getElementById('action_taken');
  const detailsScoreElement = document.getElementById('details-label-score');
  const actionScoreElement = document.getElementById('action-label-score');
  const detailsFeedback = document.getElementById('detailsFeedback');
  const actionFeedback = document.getElementById('actionFeedback');

  calculateScore(detailsTextArea.value, 'details');
  calculateScore(actionTakenTextArea.value, 'action_taken');

  detailsTextArea.addEventListener('input', (e) => handleInput(e, 'details'));
  actionTakenTextArea.addEventListener('input', (e) => handleInput(e, 'action_taken'));

  // Load data.json then populate cause/category/subcategory
  $.getJSON("/static/data.json", function(data) {
    jsonData = data;
    populateCauseCode();
    autoSelectValues();
  });

  $("#cause_code").change(function() {
    populateCategory($(this).val());
  });

  $("#category").change(function() {
    populateSubCategory($("#cause_code").val(), $(this).val());
  });

  // state affects resolution type options
  $("#state").change(function() {
    const s = $(this).val();
    setResolutionTypeOptions(s);
  });

  $("#sub_state").change(function() {
    updateConditionalBlocks();
  });

  // initial conditional state
  updateConditionalBlocks();

  // ---------- Main submit button: validate + open modal ----------
  $("#submitBtn").click(function() {
    const stateVal = $("#state").val();
    const subState = $("#sub_state").val();
    const cause_code = $("#cause_code").val();
    const category = $("#category").val();
    const sub_category = $("#sub_category").val();
    const details = $("#details").val();
    const action_taken = $("#action_taken").val();
    const resolution_type = $("#resolution_type").val();
    const PendingProblem = $("#PendingProblem").val();
    const PendingChange = $("#PendingChange").val();
    const Duplicate = $("#duplicate").val();
    const workNotes = $("#work_notes").val();

    let isvalid = true;
    $(".form-control").removeClass("is-invalid");
    $("#errorMsg").hide().text("");

    if(!stateVal) { $("#state").addClass("is-invalid"); isvalid = false; }
    if(!subState) { $("#sub_state").addClass("is-invalid"); isvalid = false; }
    if(!cause_code) { $("#cause_code").addClass("is-invalid"); isvalid = false; }
    if(!category) { $("#category").addClass("is-invalid"); isvalid = false; }
    if(!sub_category) { $("#sub_category").addClass("is-invalid"); isvalid = false; }
    if(!details || detailsScore < 75) { $("#details").addClass("is-invalid"); isvalid = false; }
    if(!action_taken || actionScore < 75) { $("#action_taken").addClass("is-invalid"); isvalid = false; }
    if(!resolution_type) { $("#resolution_type").addClass("is-invalid"); isvalid = false; }

    if(subState === "Pending_Problem" && !PendingProblem) { $("#PendingProblem").addClass("is-invalid"); isvalid = false; }
    if(subState === "Pending_Change" && !PendingChange) { $("#PendingChange").addClass("is-invalid"); isvalid = false; }
    if(subState === "Duplicate" && !Duplicate) { $("#duplicate").addClass("is-invalid"); isvalid = false; }

    if(!isvalid) {
      $("#errorMsg").text("Please fill all the fields before submitting").show();
      return;
    }

    // modal visibility blocks
    $("#a1").toggle(subState === "Pending_Problem");
    $("#a2").toggle(subState === "Pending_Change");
    $("#a3").toggle(subState === "Duplicate");

    // fill modal
    $("#modalState").val(stateVal);
    $("#modalSubState").val(subState);
    $("#modalProblem").val(PendingProblem);
    $("#modalChange").val(PendingChange);
    $("#modalDuplicate").val(Duplicate);
    $("#modalCause").val(cause_code);
    $("#modalWork").val(workNotes);

    const closureNote =
      `Category : ${category}\n` +
      `Sub_Category : ${sub_category}\n` +
      `RCA : ${details}\n` +
      `Action Taken : ${action_taken}\n` +
      `Resolution Type : ${resolution_type}`;

    $("#modalText").val(closureNote);

    // ensure modal submit button is re-enabled each time modal is opened
    const saveBtn = document.getElementById('saveBtn');
    if (saveBtn) {
      saveBtn.disabled = false;
      saveBtn.classList.remove('disabled');
      saveBtn.textContent = "Submit";
    }

    $("#myModal").modal("show");
  });

  // ---------- Modal submit: disable + grey out on first click, prevent double-submit ----------
  const form = document.getElementById('textForm');
  form.addEventListener('submit', async function (e) {
    e.preventDefault();

    const saveBtn = document.getElementById('saveBtn');
    const originalBtnText = saveBtn ? saveBtn.textContent : "Submit";

    if (saveBtn) {
      saveBtn.disabled = true;
      saveBtn.classList.add('disabled');
      saveBtn.textContent = "Submitting...";
    }

    try {
      const stateVal = $("#state").val();
      const subStateVal = $("#sub_state").val();

      const payloadCommon = {
        sub_state: subStateVal,
        cause_code: $("#cause_code").val(),
        category: $("#category").val(),
        sub_category: $("#sub_category").val(),
        rca: $("#details").val(),
        action_taken: $("#action_taken").val(),
        resolution_type: $("#resolution_type").val(),
        work_notes: $("#work_notes").val(),
        pending_problem: $("#PendingProblem").val(),
        pending_change: $("#PendingChange").val(),
        duplicate: $("#duplicate").val(),
        original_inc: $("#original_inc").val()
      };

      let url = "/update";
      let body = {};

      if (stateVal === "pending") {
        url = "/update1";
        body = {
          content: {
            modalState1: subStateVal,
            original_inc: payloadCommon.original_inc,
            modalWork: payloadCommon.work_notes,
            modalText1: document.getElementById('modalText').value,
            Pending_problem1: payloadCommon.pending_problem,
            Pending_Change1: payloadCommon.pending_change,
            Duplicate1: payloadCommon.duplicate,
            cause_code1: payloadCommon.cause_code
          }
        };
      } else {
        url = "/update";
        body = {
          content: {
            cause_code: payloadCommon.cause_code,
            sub_tate: subStateVal,
            original_inc: payloadCommon.original_inc,
            modalText: document.getElementById('modalText').value,
            workNotes: payloadCommon.work_notes,
            Pending_problem: payloadCommon.pending_problem,
            Pending_Change: payloadCommon.pending_change,
            Duplicate: payloadCommon.duplicate
          }
        };
      }

      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(body)
      });

      if (!response.ok) {
        let msg = `Request failed (${response.status})`;
        try {
          const errJson = await response.json();
          if (errJson && (errJson.error || errJson.message)) {
            msg = errJson.error || errJson.message;
          }
        } catch (_) {}
        throw new Error(msg);
      }

      await response.json();

      alert(stateVal === "pending"
        ? "Incident is updated in ServiceNow"
        : "Incident is closed in ServiceNow"
      );
      window.location.href = "/";

    } catch (err) {
      console.error(err);
      alert(`Submit failed. Please try again.\n\n${err.message || err}`);

      if (saveBtn) {
        saveBtn.disabled = false;
        saveBtn.classList.remove('disabled');
        saveBtn.textContent = originalBtnText || "Submit";
      }
    }
  });

  $("#resetBtn").click(function() {
    $("#state").val("resolved");
    setResolutionTypeOptions("resolved");
    $("#sub_state").val("");
    $("#cause_code").val("");
    $("#category").html('<option value="">Select Category</option>');
    $("#sub_category").html('<option value="">Select Sub Category</option>');
    $("#details").val("");
    $("#action_taken").val("");
    $("#resolution_type").val("");
    $("#work_notes").val("");
    $("#PendingProblem").val("");
    $("#PendingChange").val("");
    $("#duplicate").val("");
    $(".form-control").removeClass("is-invalid");
    $("#errorMsg").hide().text("");
    updateConditionalBlocks();
  });
</script>
{% endblock %}
